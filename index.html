<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grimcon Bingo</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/i18next/dist/umd/i18next.js"></script>

    <!-- Don't use this in production: -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <style>
      /* Set A4 size */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      @page {
        size: A4;
        margin: 0;
      }

      @media print {
        .adminTools {
          display: none !important;
        }
        .content {
          page-break-before: always;
        }
      }

      /* Set content to fill the entire A4 page */
      html,
      body {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Style content with shaded background */
      .content {
        background-color: antiquewhite;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      .name {
        font-size: xx-large;
        padding-top: 20px;
        margin-bottom: 20px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        justify-content: flex-start;
        width: 60%;
        border-bottom: 1px solid black;
      }

      .header {
        display: grid;
        grid-template-columns: 5fr 3fr;
        justify-items: end;
        justify-content: center;
      }

      .logo {
        max-width: 50%;
        max-height: 100px;
      }

      .supplement {
        max-height: 140px;
        margin-bottom: -60px;
        margin-left: -70px;
      }

      .rules {
        padding: 20px;
      }

      .rules p {
        padding-bottom: 15px;
      }

      .board {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .icon {
        width: 20px;
        height: 20px;
        vertical-align: bottom;
      }
      .row {
        display: flex;
        flex-direction: row;
        justify-content: center;
      }
      .cell {
        border: 3px solid black;
        background-color: aliceblue;
        width: 140px;
        height: 140px;
        padding: 5px;
      }
      .empty {
        border-radius: 5px;
        position: relative;
      }
      .empty:after {
        position: absolute;
        margin-top: 18px;
        bottom: 0;
        left: 0;
        right: 0;
        content: "\274c";
        font-size: 120px;
        color: #fff;
        line-height: 100px;
        text-align: center;
      }
    </style>
    <script type="text/babel">
      function Board() {
        const dummyEntries = Array.apply(null, Array(24)).map((a, id) => ({
          description: `Foobar ${id}`,
          category: "foo",
          id,
        }));

        const initialInput = {
          header: "Lorem Ipsum",
          icons: [
            {
              name: "idea",
              image: "ideskaper.png",
            },
            {
              name: "fire",
              image: "ildsjel.png",
            },
            {
              name: "merchant",
              image: "kremmer.png",
            },
            {
              name: "guide",
              image: "veiviser.png",
            },
          ],
          defaultMinimumPerCategory: 5,
          categories: [{ name: "foo" }],
          rules: ["No Rules!"],
          entries: dummyEntries,
        };

        const [input, setInput] = React.useState(initialInput);
        const [filledBoard, setFilledBoard] = React.useState([]);
        const [pickedEntries, setPickedEntries] = React.useState([]);

        React.useEffect(() => {
          setFilledBoard(input.entries);
          generateRandomEntriesList();
        }, [input]);

        React.useEffect(() => {
          setFilledBoard(shuffleArray(pickedEntries));
        }, [pickedEntries]);

        function generateRandomEntriesList() {
          input.categories.forEach((category) => {
            const filteredEntries = input.entries.filter(
              (entry) => entry.category === category.name
            );
            getRandomEntriesFromList(filteredEntries);
          });

          const remainingEntries = input.entries.filter(
            (entry) => !pickedEntries.includes(entry.id)
          );
          getRandomEntriesFromList(remainingEntries, true);
        }

        function handleFileChange(e) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.readAsText(file);
          reader.onload = () => {
            const json = JSON.parse(reader.result);
            setInput(json);
          };
          reader.onerror = () => {
            console.log("file error", reader.error);
          };
        }

        function getRandomEntriesFromList(entries, fill) {
          const MINIMUM_CATEGORY_PICKS = Math.min(
            input.defaultMinimumPerCategory,
            entries.length
          );
          const MAXIMUM_PICKS = 24;
          const MINIUM_SELECTION = fill
            ? MAXIMUM_PICKS - pickedEntries.length
            : 5;

          const MIN = 0;
          const MAX = entries.length;
          let count = 0;
          let entry = -1;
          const filteredPicks = [];
          while (filteredPicks.length < MINIUM_SELECTION && count < 5000) {
            const id = Math.floor(Math.random() * (MAX - MIN)) + MIN;
            entry = entries[id];
            count = count + 1;

            if (!entry) {
              continue;
            }

            if (!filteredPicks.includes(entry.id)) {
              filteredPicks.push(entry.id);
              continue;
            }
            if (count > 5000) {
              console.log("AAAAH!");
              break;
            }
          }
          setPickedEntries((oldArray) => [...oldArray, ...filteredPicks]);
        }

        function cell(index) {
          const id = filledBoard[index];
          const entry = input.entries.find((e, i) => i === id);
          if (!entry) {
            return null;
          }
          return (
            <div className="cell">
              {entry.description}
              {entry.icon && getIcon(entry.icon)}
            </div>
          );
        }

        function randomizeBoard(e) {
          setInput({ ...input });
        }

        function loadDefault(e) {
          fetch("grimcon2024.json")
            .then((response) => {
              if (response.ok) {
                console.log("File loaded");
              }
            })
            .then((data) => setInput(JSON.parse(data)))
            .catch((error) => console.error(error));
        }

        function shuffleArray(entries) {
          return entries.sort(() => Math.random() - 0.5);
        }

        function EmptyCell() {
          return <div className="cell empty"></div>;
        }

        function getIcon(name) {
          return (
            <img
              className={"icon"}
              src={input.icons.find((icon) => icon.name === name).image}
            />
          );
        }

        function Icons() {
          return input.icons.map((icon) => (
            <div key={Math.random()}>
              <strong>{icon.name}</strong>
              <div>{getIcon(icon.name)} </div>
            </div>
          ));
        }

        function AdminTools() {
          return (
            <div className="adminTools">
              <button type="button" onClick={randomizeBoard}>
                Randomize
              </button>
              <button type="button" onClick={loadDefault}>
                Load GrimCon 2024
              </button>
              <input type="file" onChange={handleFileChange}></input>
              <a href="grimcon2024.json" download>
                Download GrimCon2024
              </a>
            </div>
          );
        }

        const columns = [0, 1, 2, 3, 4];
        const rows = [0, 1, 2, 3, 4];
        let cellCount = 0;
        const CENTER = 2;
        return (
          <>
            <AdminTools />
            {filledBoard && (
              <div className="content">
                <div className="board">
                  {(input.logo || input.supplementImage) && (
                    <div className="header">
                      {input.logo && <img className="logo" src={input.logo} />}
                      {input.supplementImage && (
                        <img
                          className="supplement"
                          src={input.supplementImage}
                        />
                      )}
                    </div>
                  )}
                  {input.header && <div className="name">{input.header}</div>}
                  {rows.map((r) => (
                    <div className="row" key={"row" + r}>
                      {columns.map((c) => {
                        return (
                          <div className="column" key={`column${r}${c}`}>
                            {c === CENTER && r === CENTER ? (
                              <EmptyCell />
                            ) : (
                              cell(cellCount++)
                            )}
                          </div>
                        );
                      })}
                    </div>
                  ))}
                  <div className="rules">
                    {input.rules.map((rule, index) => (
                      <p key={`rule${index}`}>{rule}</p>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </>
        );
      }

      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<Board />);
    </script>
  </body>
</html>
